<!DOCTYPE html>
<html>
<head>
    <title>Nodes and Links</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  
        <style>
    #map {
        height: 600px;
        width: 900px;
    }
</style>
</head>
<body>
    


     <!-- Managing Node -->
    <div>
        <h3>Manage Nodes</h3>
        <form id="manageNodeForm">
            <input type="text" id="nodeName" placeholder="Node Name" required>
            <input type="text" id="latitude" placeholder="Latitude" required>
            <input type="text" id="longitude" placeholder="Longitude" required>
            <button type="submit" id="addNode">Add Node</button>
            <button type="button" id="deleteNode">Delete Node</button>
        </form>
    </div>
    
    <!-- Managing Links -->
    <div>
        <h3>Manage Links</h3>
        <form id="manageLinkForm">
            <input type="text" id="sourceNode" placeholder="Source Node Name" required>
            <input type="text" id="targetNode" placeholder="Target Node Name" required>
            <button type="button" id="addLink">Add Link</button>
            <button type="button" id="deleteLink">Delete Link</button>
        </form>
    </div>


    <!-- Map container -->
    <div>
        <h3>The Map</h3>
        <form id="map"></form>
    </div>


    <!-- Leaflet JavaScript, placed at the end of the body -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var lines = {}; // Global varible to store lines
        var map = L.map('map').setView([51.1657, 10.4515], 6); // Center on Germany
    
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
    
        fetch('/get-network-data')
            .then(response => response.json())
            .then(nodes => {
                nodes.forEach(node => {
                    L.marker([parseFloat(node.coordinates.y), parseFloat(node.coordinates.x)])
                        .bindPopup(node.id)
                        .addTo(map);
                });
            });
    </script>
    

    <!-- Inıtial map import -->
    <script>

        var nodes; // nodes data
        var links; // links data
    
        // Fetch and process nodes from JSON file
        fetch('/get-network-data') // Assuming you still have this endpoint for nodes
            .then(response => response.json())
            .then(data => {
                nodes = data;
                processNodesAndLinks();
            });
    
        // Fetch and process links
        fetch('/get-link-data')
            .then(response => response.json())
            .then(data => {
                links = data;
                processNodesAndLinks();
            });
    
        function processNodesAndLinks() {
            if (!nodes || !links) return; // Check if they are exist
    
            var nodeDict = {};
            nodes.forEach(node => {
                var marker = L.marker([parseFloat(node.coordinates.y), parseFloat(node.coordinates.x)])
                    .bindPopup(node.id)
                    .addTo(map);
                nodeDict[node.id] = marker.getLatLng();
            });
    
            links.forEach(link => {
                if (nodeDict[link.source] && nodeDict[link.target]) {
                    var latlngs = [nodeDict[link.source], nodeDict[link.target]];
                    var polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
                    
                // Store the line reference
                var lineKey = link.source + "-" + link.target;
                lines[lineKey] = polyline;
                    
                }
            });
        }
    </script>
    
    <!-- Managing nodes -->
    <script>
    var markers = {};  // Object to hold markers

    document.getElementById('manageNodeForm').addEventListener('submit', function(e) {
        e.preventDefault();  // Prevent the default form submission

        var nodeName = document.getElementById('nodeName').value;
        var latitude = parseFloat(document.getElementById('latitude').value);
        var longitude = parseFloat(document.getElementById('longitude').value);
        var coordKey = `${latitude},${longitude}`; // Create a unique key for the marker

        if (!isNaN(latitude) && !isNaN(longitude)) {
            if (!markers[coordKey]) {  // Check if marker doesn't already exist
                fetch('/add-node', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({name: nodeName, latitude: latitude, longitude: longitude})
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        var marker = L.marker([latitude, longitude]).addTo(map);
                        markers[coordKey] = marker;  // Save the marker
                    } else {
                        alert(data.message); // Alert if node already exists or any other server message
                    }
                })
                .catch(err => console.error(err));
            } else {
                alert("Marker already exists at these coordinates");
            }
        } else {
            alert("Invalid coordinates");
        }
    });

    document.getElementById('deleteNode').addEventListener('click', function() {
        var latitude = parseFloat(document.getElementById('latitude').value);
        var longitude = parseFloat(document.getElementById('longitude').value);
        var coordKey = `${latitude},${longitude}`;

        if (!isNaN(latitude) && !isNaN(longitude) && markers[coordKey]) {
            fetch('/delete-node', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({latitude: latitude, longitude: longitude})
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    map.removeLayer(markers[coordKey]);  // Remove the marker from the map
                    delete markers[coordKey];  // Remove the marker from the object
                    alert("Node deleted successfully");
                } else {
                    alert(data.message); // Alert if node not found or any other server message
                }
            })
            .catch(err => console.error(err));
        } else {
            alert("No marker found at these coordinates");
        }
    });


    </script>


<!-- Adding Link-->

<script>
    document.getElementById('addLink').addEventListener('click', function() {
        var sourceNodeName = document.getElementById('sourceNode').value;
        var targetNodeName = document.getElementById('targetNode').value;

        fetch('/get-link-coordinates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({source: sourceNodeName, target: targetNodeName})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
    
                var sourceCoords = data.source;
                var targetCoords = data.target;
                var latlngs = [ [sourceCoords.latitude, sourceCoords.longitude], [targetCoords.latitude, targetCoords.longitude] ];
                var polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);

                // Optionally store the line for future reference
                var lineKey = sourceNodeName + "-" + targetNodeName;
                lines[lineKey] = polyline;
                alert("Link added successfully");
            } else {
                alert(data.message); // Alert if nodes not found or other message
            }
        })
        .catch(err => console.error(err));
    });

</script>

<!-- Deleting Link -->

<script>

    document.getElementById('deleteLink').addEventListener('click', function() {
        var sourceNode = document.getElementById('sourceNode').value;
        var targetNode = document.getElementById('targetNode').value;
        var lineKey = sourceNode + "-" + targetNode;
        fetch('/delete-link', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({source: sourceNode, target: targetNode})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                    // Use the 'lines' object to find and remove the line
                if (lines[lineKey]) {
                    map.removeLayer(lines[lineKey]);  // Remove the line from the map
                    delete lines[lineKey];  // Remove the line reference from the 'lines' object
                    alert("Link deleted successfully");
                } else {
                    alert("No visual link found on the map.");
            }
            }
        })
        .catch(err => console.error(err));
    });

</script>

</body>
</html>
